<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WebRTC Chat + Video Call</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #e3f2fd, #e1bee7);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 10px;
    }
    h2 { text-align:center; color:#4a148c; margin-bottom:10px; }
    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 600px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .videos {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    video {
      width: 48%;
      max-width: 260px;
      aspect-ratio: 4/3;
      border-radius: 12px;
      background: #000;
      object-fit: cover;
    }
    @media (max-width:600px){
      .videos { flex-direction: column; }
      video { width:100%; max-width:100%; }
    }
    .chat-box {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px;
      background: #fafafa;
      height: 180px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    .message {
      margin:5px 0;
      padding:8px 12px;
      border-radius:12px;
      display:inline-block;
      max-width:80%;
      word-wrap:break-word;
    }
    .me { background:#d1c4e9; align-self:flex-end; }
    .them { background:#bbdefb; align-self:flex-start; }
    .input-row {
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    input {
      flex:1;
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      font-size:14px;
    }
    button {
      background:#7b1fa2;
      color:white;
      border:none;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      transition:0.2s;
      font-weight:500;
      flex-shrink:0;
    }
    button:hover { background:#6a1b9a; }
    #startCall { background:#0288d1; }
    #startCall:hover { background:#0277bd; }
    #endCall { background:#d32f2f; display:none; }
    #endCall:hover { background:#b71c1c; }
    #incomingCall {
      position:fixed;
      top:50%; left:50%;
      transform:translate(-50%,-50%);
      background:white;
      border-radius:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.3);
      padding:20px;
      display:none;
      z-index:100;
      text-align:center;
    }
    #incomingCall button { margin:5px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Test App 1.1 Biswash</h2>

    <div class="videos">
      <video id="localVideo" autoplay muted playsinline></video>
      <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div id="messages" class="chat-box"></div>

    <div class="input-row">
      <input id="input" type="text" placeholder="Type a message..." />
      <button id="send">Send</button>
      <button id="startCall">Start Call</button>
      <button id="endCall">End Call</button>
    </div>
  </div>

  <div id="incomingCall">
    <p>ðŸ“ž Incoming call...</p>
    <button id="acceptCall">Accept</button>
    <button id="rejectCall">Reject</button>
  </div>

<script>
const socket = new WebSocket("wss://websockets-7iya.onrender.com");

const messagesDiv = document.getElementById("messages");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");
const startCallBtn = document.getElementById("startCall");
const endCallBtn = document.getElementById("endCall");

const incomingDiv = document.getElementById("incomingCall");
const acceptBtn = document.getElementById("acceptCall");
const rejectBtn = document.getElementById("rejectCall");

let peer, localStream;
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");

function addMessage(text, me=false){
  const msg = document.createElement("div");
  msg.className = "message "+(me?"me":"them");
  msg.textContent=text;
  messagesDiv.appendChild(msg);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

sendBtn.onclick = ()=>{
  const text=input.value.trim();
  if(text){
    addMessage("You: "+text,true);
    socket.send(JSON.stringify({type:"chat",text}));
    input.value="";
  }
}
input.addEventListener("keypress",e=>e.key==="Enter" && sendBtn.click());

function createPeer(){
  peer = new RTCPeerConnection();
  peer.ontrack = (e)=> remoteVideo.srcObject=e.streams[0];
  peer.onicecandidate=(e)=>{
    if(e.candidate) socket.send(JSON.stringify({type:"candidate",candidate:e.candidate}));
  };
}

async function startCall(){
  createPeer();
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject = localStream;
  localStream.getTracks().forEach(track=>peer.addTrack(track,localStream));
  const offer = await peer.createOffer();
  await peer.setLocalDescription(offer);
  socket.send(JSON.stringify({type:"offer",offer}));

  startCallBtn.style.display="none";
  endCallBtn.style.display="inline-block";
}

async function endCall(){
  if(localStream) localStream.getTracks().forEach(track=>track.stop());
  if(peer){ peer.close(); peer=null; }
  localVideo.srcObject=null;
  remoteVideo.srcObject=null;
  startCallBtn.style.display="inline-block";
  endCallBtn.style.display="none";
  socket.send(JSON.stringify({type:"endCall"}));
  addMessage("ðŸ“ž Call ended",true);
}

startCallBtn.onclick=startCall;
endCallBtn.onclick=endCall;

acceptBtn.onclick = async ()=>{
  incomingDiv.style.display="none";
  createPeer();
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  localVideo.srcObject = localStream;
  localStream.getTracks().forEach(track=>peer.addTrack(track,localStream));
  await peer.setRemoteDescription(new RTCSessionDescription(currentOffer));
  const answer = await peer.createAnswer();
  await peer.setLocalDescription(answer);
  socket.send(JSON.stringify({type:"answer",answer}));
  startCallBtn.style.display="none";
  endCallBtn.style.display="inline-block";
}

rejectBtn.onclick = ()=>{
  incomingDiv.style.display="none";
  socket.send(JSON.stringify({type:"rejectCall"}));
}

let currentOffer = null;

socket.onmessage = async (event)=>{
  const data = JSON.parse(event.data);

  if(data.type==="chat") addMessage("Friend: "+data.text);
  if(data.type==="offer"){
    currentOffer = data.offer;
    incomingDiv.style.display="block";
  }
  if(data.type==="answer" && peer)
    await peer.setRemoteDescription(new RTCSessionDescription(data.answer));
  if(data.type==="candidate" && data.candidate && peer)
    await peer.addIceCandidate(data.candidate);
  if(data.type==="endCall"){
    endCall();
    addMessage("ðŸ“´ Friend ended the call");
  }
  if(data.type==="rejectCall"){
    alert("Friend rejected the call");
    endCall();
  }
};
</script>
</body>
</html>
